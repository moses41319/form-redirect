<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>🔄 正在為您載入表單...</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding-top: 50px;
    }
  </style>
</head>
<body>
  <h2>🔄 正在為您載入表單...</h2>
  <p id="status">請稍候...</p>

  <script>
    const liffId = '2007867560-ElN1bVyv'; // ✅ 你的 LIFF ID
    const queryApi = 'https://script.google.com/macros/s/AKfycbx1BY73Mot0RqLcZif3of3HLnskcbDCcUweQTj7j3yra-Dkz9E-8CSFbVR-qBVd6eDD/exec';
    const targetForm = 'https://docs.google.com/forms/d/e/1FAIpQLSdz2vdeT-YnMk1YfhDxpgLwJKAOEjbby5po0pRfm1EBUwTpgw/viewform';

    const entryMap = {
      userId: 'entry.793703378',
      name: 'entry.152457699',
      phone: 'entry.1530988381',
      address: 'entry.1009832972',
      email: 'entry.1833264332' // ✅ 如果你沒這欄可移除
    };

    async function main() {
      try {
        await liff.init({ liffId });
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        const profile = await liff.getProfile();
        const userId = profile.userId;
        document.getElementById("status").innerText = "🔍 查詢會員資料中...";

        const res = await fetch(`${queryApi}?userId=${userId}`);
        const data = await res.json();

        if (!data.success) {
          document.getElementById("status").innerText = "❌ 查無會員資料，請先註冊。";
          return;
        }

        const params = new URLSearchParams();
        params.append(entryMap.userId, userId);
        if (data.name) params.append(entryMap.name, data.name);
        if (data.phone) params.append(entryMap.phone, '0' + String(data.phone)); // 補 0
        if (data.address) params.append(entryMap.address, data.address);
        if (data.email) params.append(entryMap.email, data.email);

        const redirectUrl = `${targetForm}?${params.toString()}`;
        document.getElementById("status").innerText = "✅ 資料取得成功，即將跳轉...";
        setTimeout(() => {
          window.location.href = redirectUrl;
        }, 1500);
      } catch (err) {
        console.error(err);
        document.getElementById("status").innerText = "❌ 發生錯誤，請稍後再試";
      }
    }

    main();
  </script>
</body>
</html>
