<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Redirecting...</title>
    <style>
      body {
        font-family: sans-serif;
        text-align: center;
        padding-top: 100px;
      }
    </style>
  </head>
  <body>
    <h2>🔁 正在為您載入表單...</h2>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
      async function main() {
        try {
          await liff.init({ liffId: "2007867560-ElN1bVyv" });

          if (!liff.isLoggedIn()) {
            liff.login();
            return;
          }

          const userProfile = await liff.getProfile();
          const userId = liff.getContext().userId;

          const targetUrl = new URLSearchParams(window.location.search).get("target");
          if (!targetUrl) {
            document.body.innerHTML = "<p>❌ 未提供表單網址</p>";
            return;
          }

          const apiUrl =
            "https://script.google.com/macros/s/AKfycbx1BY73Mot0RqLcZif3of3HLnskcbDCcUweQTj7j3yra-Dkz9E-8CSFbVR-qBVd6eDD/exec?userId=" +
            encodeURIComponent(userId);

          const response = await fetch(apiUrl);
          const memberData = await response.json();

          const filledUrl = targetUrl
            .replace("[[USER_ID]]", encodeURIComponent(userId))
            .replace("[[姓名]]", encodeURIComponent(memberData.姓名 || ""))
            .replace("[[手機]]", encodeURIComponent(memberData.手機 || ""))
            .replace("[[地址]]", encodeURIComponent(memberData.地址 || ""));

          window.location.href = filledUrl;
        } catch (error) {
          document.body.innerHTML = "<p>🚨 發生錯誤： " + error + "</p>";
          console.error(error);
        }
      }

      main();
    </script>
  </body>
</html>
