<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Redirecting...</title>
  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
</head>
<body>
  <p>正在為您載入表單...</p>

  <script>
    const liffId = '2007867560-ElN1bVyv'; // 你的 LIFF ID
    const queryApi = 'https://script.google.com/macros/s/AKfycbx1BY73Mot0RqLcZif3of3HLnskcbDCcUweQTj7j3yra-Dkz9E-8CSFbVR-qBVd6eDD/exec';
    const targetForm = 'https://docs.google.com/forms/d/e/1FAIpQLSdz2vdeT-YnMk1YfhDxpgLwJKAOEjbby5po0pRfm1EBUwTpgw/viewform';

    const entryMap = {
      userId: 'entry.793703378',
      name: 'entry.152457699',
      phone: 'entry.1530988381',
      address: 'entry.1009832972',
      email: 'entry.1833264332' // 若未設定此欄請移除
    };

    async function main() {
      await liff.init({ liffId });
      if (!liff.isLoggedIn()) liff.login();

      const userId = liff.getContext().userId;
      if (!userId) {
        alert('無法取得使用者 ID');
        return;
      }

      try {
        const res = await fetch(`${queryApi}?userId=${userId}`);
        const data = await res.json();

        if (!data.success) {
          alert('查無會員資料');
          return;
        }

        const params = new URLSearchParams();
        params.append(entryMap.userId, userId);
        if (data.name) params.append(entryMap.name, data.name);
        if (data.phone) params.append(entryMap.phone, data.phone);
        if (data.address) params.append(entryMap.address, data.address);
        if (data.email) params.append(entryMap.email, data.email);

        const redirectUrl = `${targetForm}?${params.toString()}`;
        window.location.href = redirectUrl;
      } catch (err) {
        console.error(err);
        alert('發生錯誤，請稍後再試。');
      }
    }

    main();
  </script>
</body>
</html>
