<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ğŸ”„ æ­£åœ¨ç‚ºæ‚¨è¼‰å…¥è¡¨å–®...</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding-top: 50px;
    }
    .countdown {
      font-size: 1.5em;
      margin-top: 10px;
      color: #555;
    }
  </style>
</head>
<body>
  <h2>ğŸ”„ æ­£åœ¨ç‚ºæ‚¨è¼‰å…¥è¡¨å–®...</h2>
  <div class="countdown">è«‹ç¨å€™ï¼Œå€’æ•¸ <span id="count">5</span> ç§’</div>

  <script>
    async function main() {
      await liff.init({ liffId: "2007867560-ElN1bVyv" });

      if (!liff.isLoggedIn()) {
        liff.login();
        return;
      }

      const userId = (await liff.getProfile()).userId;

      // å¾ Google Apps Script æŸ¥è©¢æœƒå“¡è³‡æ–™
      const res = await fetch(`https://script.google.com/macros/s/AKfycbx1BY73Mot0RqLcZif3of3HLnskcbDCcUweQTj7j3yra-Dkz9E-8CSFbVR-qBVd6eDD/exec?userId=${userId}`);
      const userData = await res.json();

      if (!userData || !userData.success) {
        document.body.innerHTML = "<h3>âŒ æŸ¥ç„¡æœƒå“¡è³‡æ–™ï¼Œè«‹å…ˆè¨»å†Š</h3>";
        return;
      }

      // çµ„åˆ target é€£çµ
      const urlParams = new URLSearchParams(window.location.search);
      let target = urlParams.get("target");

      if (!target) {
        document.body.innerHTML = "<h3>âŒ ç¼ºå°‘ target åƒæ•¸</h3>";
        return;
      }

      // æ›¿æ›åƒæ•¸
      target = target
        .replace('[[USER_ID]]', encodeURIComponent(userId))
        .replace('[[å§“å]]', encodeURIComponent(userData.name))
        .replace('[[æ‰‹æ©Ÿ]]', encodeURIComponent('0' + userData.phone.toString()))
        .replace('[[åœ°å€]]', encodeURIComponent(userData.address))
        .replace('[[EMAIL]]', encodeURIComponent(userData.email || ''));

      // å€’æ•¸è·³è½‰
      let seconds = 5;
      const countSpan = document.getElementById('count');
      const countdown = setInterval(() => {
        seconds--;
        countSpan.textContent = seconds;
        if (seconds <= 0) {
          clearInterval(countdown);
          window.location.href = target;
        }
      }, 1000);
    }

    main();
  </script>
</body>
</html>
