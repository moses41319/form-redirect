<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>ğŸ”„ æ­£åœ¨ç‚ºæ‚¨è¼‰å…¥è¡¨å–®...</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding-top: 50px;
    }
  </style>
</head>
<body>
  <h2>ğŸ”„ æ­£åœ¨ç‚ºæ‚¨è¼‰å…¥è¡¨å–®...</h2>
  <p id="status">è«‹ç¨å€™...</p>

  <script>
    const liffId = '2007867560-ElN1bVyv'; // âœ… ä½ çš„ LIFF ID
    const queryApi = 'https://script.google.com/macros/s/AKfycbx1BY73Mot0RqLcZif3of3HLnskcbDCcUweQTj7j3yra-Dkz9E-8CSFbVR-qBVd6eDD/exec';
    const targetForm = 'https://docs.google.com/forms/d/e/1FAIpQLSdz2vdeT-YnMk1YfhDxpgLwJKAOEjbby5po0pRfm1EBUwTpgw/viewform';

    const entryMap = {
      userId: 'entry.793703378',
      name: 'entry.152457699',
      phone: 'entry.1530988381',
      address: 'entry.1009832972',
      email: 'entry.1833264332' // âœ… å¦‚æœä½ æ²’é€™æ¬„å¯ç§»é™¤
    };

    async function main() {
      try {
        await liff.init({ liffId });
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        const profile = await liff.getProfile();
        const userId = profile.userId;
        document.getElementById("status").innerText = "ğŸ” æŸ¥è©¢æœƒå“¡è³‡æ–™ä¸­...";

        const res = await fetch(`${queryApi}?userId=${userId}`);
        const data = await res.json();

        if (!data.success) {
          document.getElementById("status").innerText = "âŒ æŸ¥ç„¡æœƒå“¡è³‡æ–™ï¼Œè«‹å…ˆè¨»å†Šã€‚";
          return;
        }

        const params = new URLSearchParams();
        params.append(entryMap.userId, userId);
        if (data.name) params.append(entryMap.name, data.name);
        if (data.phone) params.append(entryMap.phone, '0' + String(data.phone)); // è£œ 0
        if (data.address) params.append(entryMap.address, data.address);
        if (data.email) params.append(entryMap.email, data.email);

        const redirectUrl = `${targetForm}?${params.toString()}`;
        document.getElementById("status").innerText = "âœ… è³‡æ–™å–å¾—æˆåŠŸï¼Œå³å°‡è·³è½‰...";
        setTimeout(() => {
          window.location.href = redirectUrl;
        }, 1500);
      } catch (err) {
        console.error(err);
        document.getElementById("status").innerText = "âŒ ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦";
      }
    }

    main();
  </script>
</body>
</html>
