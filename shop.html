<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>çµç·£å“å•†åº—</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h1>çµç·£å“å•†åº—</h1>
  <div id="log"></div>
  <div id="productArea"></div>

  <script>
    const LIFF_ID = "2007867560-LKO28Gor"; // è³¼ç‰©é çš„ LIFF ID
    const API_BASE = "https://script.google.com/macros/s/AKfycbx1BY73Mot0RqLcZif3of3HLnskcbDCcUweQTj7j3yra-Dkz9E-8CSFbVR-qBVd6eDD/exec";
    const REGISTER_LINK = "https://liff.line.me/2007867560-dlxn7yaL"; // è¨»å†Šè¡¨å–® LIFF é€£çµ

    async function main() {
      document.getElementById("log").innerText = "ğŸ”„ åˆå§‹åŒ–ä¸­...";
      await liff.init({ liffId: LIFF_ID });

      if (!liff.isLoggedIn()) {
        document.getElementById("log").innerText = "ğŸ” å°šæœªç™»å…¥ï¼Œé‡æ–°å°å‘ä¸­...";
        liff.login();
        return;
      }

      const userId = liff.getContext().userId;
      document.getElementById("log").innerText = "ğŸ” æŸ¥è©¢æœƒå“¡è³‡æ–™ä¸­...";

      // æŸ¥è©¢æœƒå“¡è³‡æ–™
      const res = await fetch(API_BASE + "?userId=" + userId);
      const result = await res.json();

      if (!result || !result.name) {
        document.getElementById("log").innerHTML = `
          âŒ æŸ¥ç„¡æœƒå“¡è³‡æ–™ï¼Œè«‹å…ˆè¨»å†Šå¾Œå†é€²è¡Œè³¼è²·ã€‚<br><br>
          <a href="${REGISTER_LINK}" target="_blank">
            ğŸ‘‰ é»æˆ‘å‰å¾€è¨»å†Š
          </a>
        `;
        return;
      }

      // é¡¯ç¤ºæœƒå“¡è³‡è¨Š
      document.getElementById("log").innerHTML = `
        âœ… å·²ç™»å…¥æœƒå“¡ï¼š<br>
        ğŸ‘¤ å§“åï¼š${result.name}<br>
        ğŸ“± æ‰‹æ©Ÿï¼š${result.phone}<br>
        ğŸ  åœ°å€ï¼š${result.address}<br><br>
        ğŸ›’ è«‹é¸æ“‡æ‚¨è¦çµç·£çš„å“é …ï¼š<br><br>
      `;

      // é¡¯ç¤ºå•†å“æŒ‰éˆ•
      const productArea = document.getElementById("productArea");
      const products = [
        { name: "é“æ…ˆç·£ç£å°çµç•Œç²‰", price: 999 },
        { name: "æä¿®ç·£æ¿Ÿå…¬ç”˜éœ²æ°´", price: 888 }
      ];

      products.forEach(p => {
        const btn = document.createElement("button");
        btn.innerText = `${p.name}ï¼ˆ${p.price}å…ƒï¼‰`;
        btn.onclick = async () => {
          btn.disabled = true;
          btn.innerText = "â³ è™•ç†ä¸­...";

          const payload = {
            userId,
            name: result.name,
            phone: result.phone,
            address: result.address,
            item: p.name,
            price: p.price
          };

          const submit = await fetch(API_BASE, {
            method: "POST",
            body: JSON.stringify(payload)
          });

          const resp = await submit.text();
          alert("âœ… çµç·£æˆåŠŸï¼š" + resp);
          btn.innerText = "âœ… å·²å®Œæˆ";
        };
        productArea.appendChild(btn);
        productArea.appendChild(document.createElement("br"));
      });
    }

    main();
  </script>
</body>
</html>
