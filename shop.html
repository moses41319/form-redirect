<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>結緣品商店</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h1>結緣品商店</h1>
  <div id="log"></div>
  <div id="productArea"></div>

  <script>
    const LIFF_ID = "2007867560-LKO28Gor"; // ✅ 替換為你的最新 LIFF ID
    const API_BASE = "https://script.google.com/macros/s/AKfycbx1BY73Mot0RqLcZif3of3HLnskcbDCcUweQTj7j3yra-Dkz9E-8CSFbVR-qBVd6eDD/exec";

    async function main() {
      document.getElementById("log").innerText = "初始化中...";
      await liff.init({ liffId: LIFF_ID });

      if (!liff.isLoggedIn()) {
        document.getElementById("log").innerText = "尚未登入，重新導向中...";
        liff.login();
        return;
      }

      const profile = await liff.getProfile();
      const userId = liff.getContext().userId;
      document.getElementById("log").innerText = "載入中... " + userId;

      // 查詢會員資料
      const res = await fetch(API_BASE + "?userId=" + userId);
      const result = await res.json();

      if (!result || !result.name) {
        document.getElementById("log").innerText = "查無會員資料，請先註冊。";
        return;
      }

      // 顯示會員資訊
      document.getElementById("log").innerHTML = `
        👤 姓名：${result.name}<br>
        📱 手機：${result.phone}<br>
        🏠 地址：${result.address}<br><br>
      `;

      // 顯示商品按鈕
      const productArea = document.getElementById("productArea");
      const products = [
        { name: "道慈緣督導結界粉", price: 999, id: "item1" },
        { name: "李修緣濟公甘露水", price: 888, id: "item2" }
      ];

      products.forEach(p => {
        const btn = document.createElement("button");
        btn.innerText = `${p.name}（${p.price}元）`;
        btn.onclick = async () => {
          btn.disabled = true;
          btn.innerText = "處理中...";

          const payload = {
            userId,
            name: result.name,
            phone: result.phone,
            address: result.address,
            item: p.name,
            price: p.price
          };

          const submit = await fetch(API_BASE, {
            method: "POST",
            body: JSON.stringify(payload)
          });

          const resp = await submit.text();
          alert("✅ 結緣成功：" + resp);
          btn.innerText = "已購買";
        };
        productArea.appendChild(btn);
        productArea.appendChild(document.createElement("br"));
      });
    }

    main();
  </script>
</body>
</html>
